"use client";

import { useClimateArtifact } from "@/hooks/useClimateArtifact";
import { useClimateState } from "@/hooks/useClimateState";
import ChartContainer from "@/components/shared/ChartContainer";
import StoryHeader from "@/components/climate/StoryHeader";
import { selectNationalPopulation } from "@/lib/selectors/population";
import { selectFemaCounts } from "@/lib/selectors/disasters";
import { mergeYearSeries } from "@/utils/array";
import YearReadout from "../climate/YearReadout";
import DownloadPanel from "../controls/DownloadPanel";
import dynamic from 'next/dynamic';

const PopulationDisasterChart = dynamic(() => import("@/components/charts/PopulationDisasterChart"), { ssr: false });

const SOURCES = [
  { name: "U.S. Census ACS", url: "https://www.census.gov/programs-surveys/acs" },
  { name: "NIFC", url: "https://www.nifc.gov/fire-information/statistics/wildfires" },
];

export default function StoryPopulationVulnerability() {
  const { data, isLoading, isError, error } = useClimateArtifact();
  const { disasterTypes, setState } = useClimateState();

  if (!data) {
    return <ChartContainer isLoading={isLoading} isError={isError} error={error as Error | null}><div /></ChartContainer>;
  }

  const populationSeries = selectNationalPopulation(data);
  const { series: disasterCounts, byType } = selectFemaCounts(data, { 
    scope: 'national',
    types: disasterTypes, 
    cadence: 'annual' 
  });

  // Merge the data series
  const mergedData = mergeYearSeries(populationSeries, disasterCounts);

  const chartData = {
    population: mergedData.map(([year, population]) => ({ x: year, y: population })),
    disasters: mergedData.map(([year, _, disasters]) => ({ x: year, y: disasters })),
  };

  // Prepare data by disaster type for the chart
  const disasterTypeData = Object.entries(byType).map(([type, series]) => ({
    id: type,
    data: series.map(([year, count]) => ({ x: year, y: count }))
  }));

  return (
    <div>
      <StoryHeader
        title="Population Growth and Climate Vulnerability"
        description="How has the growing U.S. population affected exposure to climate-related disasters?"
        sources={SOURCES}
      />
      <ChartContainer isLoading={isLoading} isError={isError} error={error}>
        <PopulationDisasterChart 
          data={chartData}
          disasterTypeData={disasterTypeData}
        />
        <YearReadout />
      </ChartContainer>
    </div>
  );
}
